{"version":3,"file":"index.js","sources":["../src/helpers/index.js","../src/core/NodeKey/getKeyByFiberNode.js","../src/core/NodeKey/getKeyByPreactNode.js","../src/core/NodeKey/index.js"],"sourcesContent":["export function getKey2Id() {\n  let uuid = 0\n  const map = new Map()\n\n  // 对每种 NodeType 做编号处理\n  return function key2Id(key) {\n    let id = map.get(key)\n\n    if (!id) {\n      id = (++uuid).toString(32)\n      map.set(key, id)\n    }\n\n    return id\n  }\n}\n","import { isString, isFunction, get, run } from 'szfe-tools'\n\nimport { getKey2Id } from '../../helpers'\n\nconst isArrReg = /^iAr/\n\n// 对每种 NodeType 做编号处理\nconst key2Id = getKey2Id()\n\n// 获取节点的渲染路径，作为节点的 X 坐标\nconst genRenderPath = (node) =>\n  node.return ? [node, ...genRenderPath(node.return)] : [node]\n\n// 使用节点 _nk 属性或下标与其 key/index 作为 Y 坐标\nconst getNodeId = (fiberNode) => {\n  // FIXME: 使用 index 作为 Y 坐标是十分不可靠的行为，待想出更好的法子替代\n  const id = get(fiberNode, 'key') || fiberNode.index\n  const nodeKey = get(fiberNode, 'memoizedProps._nk') || get(fiberNode, 'pendingProps._nk')\n  const isArray = isString(nodeKey) && isArrReg.test(nodeKey)\n\n  return isArray ? `${nodeKey}.${id}` : nodeKey || id\n}\n\nconst markNode = (node) => {\n  const x = key2Id(get(node, 'type.$$typeof', node.type))\n  const y = getNodeId(node)\n\n  return `${x},${y}`\n}\n\n// 根据 X,Y 坐标生成 Key\nconst getKeyByCoord = (nodes, handleNode) =>\n  nodes\n    .map((node) => {\n      const mark = markNode(node)\n\n      return isFunction(handleNode)\n        ? run(handleNode, undefined, node, mark)\n        : mark\n    })\n    .filter(Boolean)\n    .join('|')\n\nconst getKeyByFiberNode = (fiberNode, handleNode) => {\n  const key = getKeyByCoord(genRenderPath(fiberNode), handleNode)\n\n  return key2Id(key)\n}\n\nexport default getKeyByFiberNode\n","import { isString, isFunction, get, run } from 'szfe-tools'\n\nimport { getKey2Id } from '../../helpers'\n\nconst isArrReg = /^iAr/\n\n// 对每种 NodeType 做编号处理\nconst key2Id = getKey2Id()\n\n// 获取节点的渲染路径，作为节点的 X 坐标\nconst genRenderPath = (node) =>\n  node.__ ? [node, ...genRenderPath(node.__)] : [node]\n\n// 使用节点 _nk 属性或下标与其 key/index 作为 Y 坐标\nconst getNodeId = (node) => {\n  // FIXME: Preact 无 index 属性，无 key 与 _nk 之下 Y 坐标不可靠，待修正\n  const id = get(node, 'key') || node.index\n  const nodeKey = get(node, 'props._nk')\n  const isArray = isString(nodeKey) && isArrReg.test(nodeKey)\n\n  return isArray ? `${nodeKey}.${id}` : nodeKey || id\n}\n\nconst markNode = (node) => {\n  const x = key2Id(node.type)\n  const y = getNodeId(node)\n\n  return `${x},${y}`\n}\n\n// 根据 X,Y 坐标生成 Key\nconst getKeyByCoord = (nodes, handleNode) =>\n  nodes\n    .map((node) => {\n      const mark = markNode(node)\n\n      return isFunction(handleNode)\n        ? run(handleNode, undefined, node, mark)\n        : mark\n    })\n    .filter(Boolean)\n    .join('|')\n\nconst getKeyByNode = (node, handleNode) => {\n  const key = getKeyByCoord(genRenderPath(node), handleNode)\n\n  return key2Id(key)\n}\n\nexport default getKeyByNode\n","import { Component } from 'react'\nimport { run } from 'szfe-tools'\n\nimport getKeyByFiberNode from './getKeyByFiberNode'\nimport getKeyByPreactNode from './getKeyByPreactNode'\n\nlet type\n\n// 根据 FiberNode 所处位置来确定 nodeKey\nexport default class NodeKey extends Component {\n  static defaultProps = {\n    onHandleNode: undefined,\n    manualKey: undefined,\n    prefix: '',\n  }\n\n  key = null\n  genKey = (onHandleNode) => {\n    if (!type) {\n      // _reactInternals 为 React v17 fiberNode 节点字段\n      if (this._reactInternalFiber || this._reactInternals) {\n        type = 'React'\n      }\n\n      // TODO: May \"preact/compat\" mode only, not verified yet.\n      if (this.__v) {\n        type = 'Preact'\n      }\n    }\n\n    switch (type) {\n      case 'Preact': {\n        this.key = getKeyByPreactNode(this.__v, onHandleNode)\n        break\n      }\n      case 'React': {\n        const fiberNode = this._reactInternalFiber || this._reactInternals\n        this.key = getKeyByFiberNode(fiberNode, onHandleNode)\n        break\n      }\n      default: {\n        break\n      }\n    }\n\n    return this.key\n  }\n\n  render() {\n    const { manualKey, children, prefix, onHandleNode } = this.props\n\n    return run(\n      children,\n      undefined,\n      `${prefix}${manualKey, this.key || this.genKey(onHandleNode)}`\n    )\n  }\n}\n"],"names":["getKey2Id","uuid","map","Map","key2Id","key","id","get","toString","set","isArrReg","genRenderPath","node","getNodeId","fiberNode","index","nodeKey","isArray","test","markNode","x","type","y","getKeyByCoord","nodes","handleNode","mark","undefined","filter","Boolean","join","getKeyByFiberNode","__","getKeyByNode","NodeKey","onHandleNode","_reactInternalFiber","_reactInternals","__v","getKeyByPreactNode","props","manualKey","children","prefix","genKey","Component"],"mappings":"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"}